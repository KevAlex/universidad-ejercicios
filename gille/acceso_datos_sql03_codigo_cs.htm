<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>


<meta http-equiv="Window-target" content="_top">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="MS.LOCALE" content="es">
<meta name="MSHAttr" content="DocSet:NETFramework">
<meta name="MSHAttr" content="DevLang:CSharp">
<meta name="MSHAttr" content="DocSet:C#">
<meta name="MSHAttr" content="DevLang:ADO">
<meta name="MSHAttr" content="DevLang:ASP">

<link href="acceso_datos_sql03_codigo_cs_files/estiloArticulosGuille.css" type="text/css" rel="stylesheet">
<meta name="Author" content="Guillermo 'guille' Som">
<meta name="Search.TopicType" content="kbArticle">
<meta name="Search.PublishDate" content="Sun, 04 Feb 2007 19:45:45 GMT">
<meta name="Search.RevisedDate" content="Sun, 04 Feb 2007 19:45:45 GMT"><title>Código de ModificarUsuario.aspx.cs</title>

<meta name="description" content="Código de Visual C# 2005 de la página ModificarUsuario.aspx del Tutorial de acceso a datos desde páginas Web usando Visual Web Developer 2005."></head><body alink="#ff0000" bgcolor="#d7d7ff" link="#0000ff" vlink="#0000ff">

<script language="JavaScript">
var gsPath = "../../../"
function IrADeLista(){
    var s1 = gsBanner.D1.selectedIndex;
    var s2 = gsBanner.D1.options[s1].value;
    if( s2 != "Selecciona" )
        window.location = gsPath + s2;
}
</script>
<script language="JavaScript" src="acceso_datos_sql03_codigo_cs_files/elGuille.js"></script><table border="1" width="100%">  <tbody><tr>    <td rowspan="2" align="middle" valign="middle" width="200">       <a href="http://www.elguille.info/default.aspx">       <img src="acceso_datos_sql03_codigo_cs_files/el_guille.gif" alt="ir al indice principal" border="0"></a>    </td>    <td align="middle">       <font color="#000080" face="Comic Sans MS" size="4"><strong><a href="http://www.elguille.info/el_guille.aspx" style="color: navy;"><acronym title="Quien es el Guille?">el Guille</acronym></a>, la Web del Visual Basic, C#, .NET y más...</strong></font>    </td>  </tr>   <tr>       <td align="middle" background="acceso_datos_sql03_codigo_cs_files/barra_grisclaro.png" height="20"><b><font face="Verdana" size="1">&nbsp;       <a href="http://www.elguille.info/lonuevo/2007/octubre/Default.aspx"><acronym title="Lo Nuevo de este mes">Lo+</acronym></a> -       <a href="http://www.elguille.info/NET/WinFX/default.aspx"><acronym title="Indice de WinFX, WPF, WWF, WCF y .NET 3.0">WinFX</acronym></a> -       <a href="http://www.elguille.info/NET/default.aspx"><acronym title="El indice de punto NET">.NET</acronym></a> -       <a href="http://www.elguille.info/NET/ADONET/indiceADONET.asp"><acronym title="Bases de datos de punto NET">ADO.NET</acronym></a> -       <a href="http://www.elguille.info/NET/ASPNET/indiceASPNET.aspx"><acronym title="Paginas y servicios Web en punto NET">ASP.NET</acronym></a> -       <a href="http://www.elguille.info/NET/comodotnet.aspx"><acronym title="Como... en punto NET">Cómo...</acronym></a> -       <a href="http://www.elguille.info/colabora/colabora.htm"><acronym title="Las colaboraciones">Colabora</acronym></a> -       <a href="http://www.elguille.info/vb/default.aspx"><acronym title="El indice de Visual Basic 6">VB6</acronym></a> -       <a href="http://www.elguille.info/vb/VB_API.HTM"><acronym title="API de Windows (VB6)">API</acronym></a> -       <a href="http://www.elguille.info/HTMLscripts/HTML_Tip.aspx"><acronym title="Lenguajes Scripts y HTML">HTML</acronym></a> -       <a href="http://www.elguille.info/sistema/Vista/Default.aspx"><acronym title="Articulos y trucos para Windows Vista">Vista</acronym></a> -       <a href="http://www.elguille.info/otrositios/Default.aspx"><acronym title="Otros sitios">Links</acronym></a>&nbsp;-       <a href="http://www.elguille.info/foros_guille.aspx"><acronym title="Los foros del Guille">Foros</acronym></a>       &nbsp;</font></b></td>   </tr></tbody></table><div class="colorClaro" style="padding-top: 1em; padding-bottom: 1em;" align="center"><h2><a href="http://www.elguille.info/NET/MIVB2005/comprar.asp">Regalate mi libro de Visual Basic 2005</a></h2></div>
<hr style="border: 3px none ;">
&nbsp;

<div align="center">
<table style="border-collapse: collapse;" id="tablePanorama" bgcolor="#ffffff" border="1" bordercolor="#000000" cellpadding="8" width="770">
<tbody><tr><td style="padding: 0cm 5pt; width: 770px;" align="left" bgcolor="#0000ff" valign="top" width="770">
<a href="http://www.elguille.info/NET/ASPNET/indiceASPNET.aspx"><font color="#ffffff" size="6"><b><acronym title="Ir a la sección de ASP.NET">
ASP.NET</acronym></b></font></a></td>
</tr>
<tr>
<td style="padding: 0cm 5pt; width: 770px;" align="left" valign="top" width="770">
&nbsp;<h2>Código de Visual C# de la página ModificarUsuario.aspx
del Tutorial de acceso a datos desde páginas Web usando Visual Web Developer 
2005</h2>
<p>&nbsp;</p>
<h5>Publicado el 04/Feb/2007<br>Actualizado el 04/Feb/2007<br>Autor: Guillermo 'guille' Som</h5>
<p>&nbsp;</p></td>
</tr>
</tbody></table>
</div>

<div>
<br>
<div align="center">
<table style="border-collapse: collapse;" bgcolor="#ffffff" border="1" bordercolor="#000000" cellpadding="2" cellspacing="8" width="770">
 <tbody><tr>
  <td style="padding: 0cm 5pt; width: 770px;" align="left" valign="top" width="770">
<p>&nbsp;</p>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3672683940926460";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_type = "text";
//2007-04-01: net2005
google_ad_channel = "6593407188";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "000000";
//-->
</script>
<script type="text/javascript" src="acceso_datos_sql03_codigo_cs_files/show_ads.js">
</script><iframe name="google_ads_frame" src="acceso_datos_sql03_codigo_cs_files/ads.htm" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" frameborder="0" height="90" scrolling="no" width="728"></iframe>
</center>  

  <p>&nbsp;</p>
	<p>Este es el código de Visual C# 2005 de la página que habrás creado usando las indicaciones 
	de la tercera parte del <a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql03.htm">Tutorial de acceso a datos en sitio Web creado con Visual Web 
Developer 2005 Express y SQL Server 2005 Express</a>.</p>
	<p>&nbsp;</p>
    <div align="center">
    <table style="border-collapse: collapse;" id="tablaVB" border="1" bordercolor="#000000" cellpadding="2" width="100%">
      <tbody><tr>
          <td style="text-align: left;" bgcolor="#ccffcc">
  <h3>&nbsp;El código de Visual C# 2005</h3>
          </td>
      </tr>
      <tr>
          <td style="text-align: left;">
<pre><span style="color: rgb(0, 0, 255);">using</span> System;
<span style="color: rgb(0, 0, 255);">using</span> System.Data;
<span style="color: rgb(0, 0, 255);">using</span> System.Configuration;
<span style="color: rgb(0, 0, 255);">using</span> System.Collections;
<span style="color: rgb(0, 0, 255);">using</span> System.Web;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.Security;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI.WebControls;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI.WebControls.WebParts;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI.HtmlControls;

<span style="color: rgb(0, 0, 255);">using</span> System.Data.SqlClient;

<span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">partial</span> <span style="color: rgb(0, 0, 255);">class</span> ModificarUsuario_cs : System.Web.UI.Page
{
    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> Page_Load(<span style="color: rgb(0, 0, 255);">object</span> sender, EventArgs e)
    {

    }

    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> btnActualizar_Click(<span style="color: rgb(0, 0, 255);">object</span> sender, EventArgs e)
    {
        <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = "";
        <span style="color: rgb(0, 128, 0);">//</span>
        <span style="color: rgb(0, 128, 0);">// Comprobamos si el nombre ya existe</span>
        <span style="color: rgb(0, 0, 255);">using</span> (SqlConnection cnn = 
                    <span style="color: rgb(0, 0, 255);">new</span> SqlConnection(<span style="color: rgb(0, 0, 255);">this</span>.SqlDataSource1.ConnectionString))
        {
            <span style="color: rgb(0, 128, 0);">// El valor que necesitamos es el ID</span>
            SqlCommand cmd = <span style="color: rgb(0, 0, 255);">new</span> SqlCommand(
                <span style="color: rgb(178, 34, 34);">"SELECT ID "</span> +
                <span style="color: rgb(178, 34, 34);">"FROM Usuarios "</span> +
                <span style="color: rgb(178, 34, 34);">"WHERE Correo = @Correo"</span>, cnn);
            <span style="color: rgb(0, 128, 0);">// Abrimos la conexión</span>
            cnn.Open();
            <span style="color: rgb(0, 128, 0);">// Añadimos el valor del parámetro de la consulta</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text);

            <span style="color: rgb(0, 128, 0);">// Si devuelve cero, es que no existe</span>
            <span style="color: rgb(0, 0, 255);">int</span> i = (<span style="color: rgb(0, 0, 255);">int</span>)cmd.ExecuteScalar();
            <span style="color: rgb(0, 0, 255);">if</span> (i == 0)
            {
                <span style="color: rgb(0, 128, 0);">// Avisamos y salimos</span>
                <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"El usuario NO existe"</span>;
                <span style="color: rgb(0, 0, 255);">return</span>;
            }

            <span style="color: rgb(0, 128, 0);">// Si llegamos aquí, es que el usuario existe</span>
            <span style="color: rgb(0, 128, 0);">// Deberíamos hacer las comprobaciones de que haya datos que guardar,</span>
            <span style="color: rgb(0, 128, 0);">// pero... eso te lo dejo a ti...</span>
            <span style="color: rgb(0, 128, 0);">//</span>
            <span style="color: rgb(0, 128, 0);">// Seguimos usando la misma conexión, pero cambiamos el comando</span>

            <span style="color: rgb(0, 128, 0);">// Usamos el comando Update del DataSource</span>
            cmd = <span style="color: rgb(0, 0, 255);">new</span> SqlCommand(<span style="color: rgb(0, 0, 255);">this</span>.SqlDataSource1.UpdateCommand, cnn);

            <span style="color: rgb(0, 128, 0);">// Añadimos el valor del parámetro de la consulta</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text);
            <span style="color: rgb(0, 128, 0);">// La clave la guardaremos como un valor SHA1</span>
            <span style="color: rgb(0, 128, 0);">// pero como ya estará como SHA1, simplemente la asignamos</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Clave"</span>, txtClave.Text);
            <span style="color: rgb(0, 128, 0);">// Esto nos puede dar problemas dependiendo del forma</span>
            <span style="color: rgb(0, 128, 0);">// del servidor en el que está la base de datos</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Fecha"</span>, txtFecha.Text);
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Nombre"</span>, txtNombre.Text);
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Comentarios"</span>, txtComentarios.Text);

            <span style="color: rgb(0, 128, 0);">// El valor de la variable i es el ID a actualizar</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@ID"</span>, i);

            <span style="color: rgb(0, 128, 0);">// Ejecutamos el comando de actualización</span>
            <span style="color: rgb(0, 128, 0);">// con una llamada a ExecuteNonQuery</span>
            cmd.ExecuteNonQuery();


            <span style="color: rgb(0, 128, 0);">// Al salir del bloque using se cierra la conexión</span>
        }
        <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"Se ha añadido el nuevo usuario correctamente"</span>;
    }

    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> btnMostrar_Click(<span style="color: rgb(0, 0, 255);">object</span> sender, EventArgs e)
    {
        <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = "";
        <span style="color: rgb(0, 128, 0);">//</span>
        <span style="color: rgb(0, 128, 0);">// Comprobamos si el nombre ya existe</span>
        <span style="color: rgb(0, 0, 255);">using</span> (SqlConnection cnn = <span style="color: rgb(0, 0, 255);">new</span> SqlConnection(<span style="color: rgb(0, 0, 255);">this</span>.SqlDataSource1.ConnectionString))
        {
            <span style="color: rgb(0, 128, 0);">// La cadena de slección será la que tenga el DataSource,</span>
            <span style="color: rgb(0, 128, 0);">// pero buscando el correo que hemos escrito</span>
            <span style="color: rgb(0, 128, 0);">//string sel;</span>
            <span style="color: rgb(0, 128, 0);">//sel = this.SqlDataSource1.SelectCommand + </span>
            <span style="color: rgb(0, 128, 0);">//        " WHERE Correo = @Correo";</span>
            <span style="color: rgb(0, 128, 0);">//SqlCommand cmd = new SqlCommand(sel, cnn);</span>
            
            <span style="color: rgb(0, 128, 0);">// Usando un procedimiento almacenado</span>
            SqlCommand cmd = <span style="color: rgb(0, 0, 255);">new</span> SqlCommand();
            cmd.CommandText = <span style="color: rgb(178, 34, 34);">"MostrarUsuario"</span>;
            cmd.CommandType = CommandType.StoredProcedure;
            cmd.Connection = cnn;

            <span style="color: rgb(0, 128, 0);">// Abrimos la conexión</span>
            cnn.Open();
            <span style="color: rgb(0, 128, 0);">// Añadimos el valor del parámetro de la consulta</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text);

            <span style="color: rgb(0, 128, 0);">// El resultado lo guardaremos en una tabla</span>
            DataTable tabla = <span style="color: rgb(0, 0, 255);">new</span> DataTable();
            <span style="color: rgb(0, 128, 0);">// Usaremos un DataAdapter para leer los datos</span>
            SqlDataAdapter da = <span style="color: rgb(0, 0, 255);">new</span> SqlDataAdapter(cmd);
            <span style="color: rgb(0, 128, 0);">// Llenamos la tabla con los datos leídos</span>
            da.Fill(tabla);

            <span style="color: rgb(0, 128, 0);">// Si la tabla no tiene filas, es que no existe ese usuario</span>
            <span style="color: rgb(0, 0, 255);">if</span> (tabla.Rows.Count == 0)
            {
                <span style="color: rgb(0, 128, 0);">// Avisamos y salimos</span>
                <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"El usuario NO existe"</span>;
                <span style="color: rgb(0, 0, 255);">return</span>;
            }

            <span style="color: rgb(0, 128, 0);">// Mostramos los datos</span>
            <span style="color: rgb(0, 128, 0);">// que estarán en la primera fila de la tabla,</span>
            <span style="color: rgb(0, 128, 0);">// ya que solo debería haber un solo usuario con ese correo</span>
            <span style="color: rgb(0, 0, 255);">this</span>.txtClave.Text = tabla.Rows[0][<span style="color: rgb(178, 34, 34);">"Clave"</span>].ToString();
            <span style="color: rgb(0, 0, 255);">this</span>.txtFecha.Text = tabla.Rows[0][<span style="color: rgb(178, 34, 34);">"Fecha"</span>].ToString();
            <span style="color: rgb(0, 0, 255);">this</span>.txtNombre.Text = tabla.Rows[0][<span style="color: rgb(178, 34, 34);">"Nombre"</span>].ToString();
            <span style="color: rgb(0, 0, 255);">this</span>.txtComentarios.Text = tabla.Rows[0][<span style="color: rgb(178, 34, 34);">"Comentarios"</span>].ToString();

            <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"El usuario existe y se han leído los datos."</span>;

            <span style="color: rgb(0, 128, 0);">// Al salir del bloque Using se cierra la conexión</span>
        }
    }

    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> btnGenerarClaveSha1_Click(<span style="color: rgb(0, 0, 255);">object</span> sender, EventArgs e)
    {
        <span style="color: rgb(0, 128, 0);">// Generar la clave SHA1 a partir de lo que haya en txtClave</span>
        <span style="color: rgb(0, 128, 0);">// y asignar nuevamente a ese mismo textBox el resultado</span>
        <span style="color: rgb(0, 0, 255);">string</span> clave;
        clave = FormsAuthentication.HashPasswordForStoringInConfigFile(
            txtClave.Text, <span style="color: rgb(178, 34, 34);">"SHA1"</span>);
        txtClave.Text = clave;
    }
}
</pre>
</td>
      </tr>
    </tbody></table>
  </div>
  <p>&nbsp;</p>
	<ul>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql03_codigo_aspx.htm">El código de la página 
		ModificarUsuario.aspx</a></li>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql03_codigo_vb.htm">El código para Visual 
		Basic 2005</a></li>
	</ul>
	<p align="center"><b><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql03.htm">Volver a la página 
	explicativa</a></b></p>
	<p>&nbsp;</p></td>
</tr>
</tbody></table>
</div>
<br>
</div>
<hr style="border: 3px none ;">
<p align="center"><a href="http://www.elguille.info/default.aspx">
<img src="acceso_datos_sql03_codigo_cs_files/el_guille_002.gif" alt="Ir al índice principal de el Guille" style="border: 0px none ;" height="50" width="200"></a></p>
</body></html>