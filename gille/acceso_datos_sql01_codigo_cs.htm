<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>


<meta http-equiv="Window-target" content="_top">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="MS.LOCALE" content="es">
<meta name="MSHAttr" content="DocSet:NETFramework">
<meta name="MSHAttr" content="DevLang:CSharp">
<meta name="MSHAttr" content="DocSet:C#">
<meta name="MSHAttr" content="DevLang:ADO">
<meta name="MSHAttr" content="DevLang:ASP">

<link href="acceso_datos_sql01_codigo_cs_files/estiloArticulosGuille.css" type="text/css" rel="stylesheet">
<meta name="Author" content="Guillermo 'guille' Som">
<meta name="Search.TopicType" content="kbArticle">
<meta name="Search.PublishDate" content="Sat, 03 Feb 2007 01:30:00 GMT">
<meta name="Search.RevisedDate" content="Sat, 03 Feb 2007 01:30:00 GMT"><title>Código de AgregarUsuario.aspx.cs</title>

<meta name="description" content="Código de Visual C# 2005 de la página AgregarUsuario.aspx del Tutorial de acceso a datos desde páginas Web usando Visual Web Developer 2005."></head><body alink="#ff0000" bgcolor="#d7d7ff" link="#0000ff" vlink="#0000ff">

<script language="JavaScript">
var gsPath = "../../../"
function IrADeLista(){
    var s1 = gsBanner.D1.selectedIndex;
    var s2 = gsBanner.D1.options[s1].value;
    if( s2 != "Selecciona" )
        window.location = gsPath + s2;
}
</script>
<script language="JavaScript" src="acceso_datos_sql01_codigo_cs_files/elGuille.js"></script><table border="1" width="100%">  <tbody><tr>    <td rowspan="2" align="middle" valign="middle" width="200">       <a href="http://www.elguille.info/default.aspx">       <img src="acceso_datos_sql01_codigo_cs_files/el_guille.gif" alt="ir al indice principal" border="0"></a>    </td>    <td align="middle">       <font color="#000080" face="Comic Sans MS" size="4"><strong><a href="http://www.elguille.info/el_guille.aspx" style="color: navy;"><acronym title="Quien es el Guille?">el Guille</acronym></a>, la Web del Visual Basic, C#, .NET y más...</strong></font>    </td>  </tr>   <tr>       <td align="middle" background="acceso_datos_sql01_codigo_cs_files/barra_grisclaro.png" height="20"><b><font face="Verdana" size="1">&nbsp;       <a href="http://www.elguille.info/lonuevo/2007/octubre/Default.aspx"><acronym title="Lo Nuevo de este mes">Lo+</acronym></a> -       <a href="http://www.elguille.info/NET/WinFX/default.aspx"><acronym title="Indice de WinFX, WPF, WWF, WCF y .NET 3.0">WinFX</acronym></a> -       <a href="http://www.elguille.info/NET/default.aspx"><acronym title="El indice de punto NET">.NET</acronym></a> -       <a href="http://www.elguille.info/NET/ADONET/indiceADONET.asp"><acronym title="Bases de datos de punto NET">ADO.NET</acronym></a> -       <a href="http://www.elguille.info/NET/ASPNET/indiceASPNET.aspx"><acronym title="Paginas y servicios Web en punto NET">ASP.NET</acronym></a> -       <a href="http://www.elguille.info/NET/comodotnet.aspx"><acronym title="Como... en punto NET">Cómo...</acronym></a> -       <a href="http://www.elguille.info/colabora/colabora.htm"><acronym title="Las colaboraciones">Colabora</acronym></a> -       <a href="http://www.elguille.info/vb/default.aspx"><acronym title="El indice de Visual Basic 6">VB6</acronym></a> -       <a href="http://www.elguille.info/vb/VB_API.HTM"><acronym title="API de Windows (VB6)">API</acronym></a> -       <a href="http://www.elguille.info/HTMLscripts/HTML_Tip.aspx"><acronym title="Lenguajes Scripts y HTML">HTML</acronym></a> -       <a href="http://www.elguille.info/sistema/Vista/Default.aspx"><acronym title="Articulos y trucos para Windows Vista">Vista</acronym></a> -       <a href="http://www.elguille.info/otrositios/Default.aspx"><acronym title="Otros sitios">Links</acronym></a>&nbsp;-       <a href="http://www.elguille.info/foros_guille.aspx"><acronym title="Los foros del Guille">Foros</acronym></a>       &nbsp;</font></b></td>   </tr></tbody></table><div class="colorClaro" style="padding-top: 1em; padding-bottom: 1em;" align="center">	<h2><span style="color: firebrick;">dotNetMania + el sitio del Guille:</span><br>	<span style="color: rgb(43, 144, 255);">La mejor informacion de punto NET!</span><br>	<a href="http://www.elguille.info/NET/revistas/dotNetmania/suscripcion_dnm.aspx">Suscribete ya!</a> y 	consigue un 10% de descuento</h2></div>
<hr style="border: 3px none ;">
&nbsp;

<div align="center">
<table style="border-collapse: collapse;" id="tablePanorama" bgcolor="#ffffff" border="1" bordercolor="#000000" cellpadding="8" width="770">
<tbody><tr><td style="padding: 0cm 5pt; width: 770px;" align="left" bgcolor="#0000ff" valign="top" width="770">
<a href="http://www.elguille.info/NET/ASPNET/indiceASPNET.aspx"><font color="#ffffff" size="6"><b><acronym title="Ir a la sección de ASP.NET">
ASP.NET</acronym></b></font></a></td>
</tr>
<tr>
<td style="padding: 0cm 5pt; width: 770px;" align="left" valign="top" width="770">
&nbsp;<h2>Código de Visual C# de la página AgregarUsuario.aspx
del Tutorial de acceso a datos desde páginas Web usando Visual Web Developer 
2005</h2>
<p>&nbsp;</p>
<h5>Publicado el 03/Feb/2007<br>Actualizado el 03/Feb/2007<br>Autor: Guillermo 'guille' Som</h5>
<p>&nbsp;</p></td>
</tr>
</tbody></table>
</div>

<div>
<br>
<div align="center">
<table style="border-collapse: collapse;" bgcolor="#ffffff" border="1" bordercolor="#000000" cellpadding="2" cellspacing="8" width="770">
 <tbody><tr>
  <td style="padding: 0cm 5pt; width: 770px;" align="left" valign="top" width="770">
<p>&nbsp;</p>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3672683940926460";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_type = "text";
//2007-04-01: net2005
google_ad_channel = "6593407188";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "000000";
//-->
</script>
<script type="text/javascript" src="acceso_datos_sql01_codigo_cs_files/show_ads.js">
</script><iframe name="google_ads_frame" src="acceso_datos_sql01_codigo_cs_files/ads.htm" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" frameborder="0" height="90" scrolling="no" width="728"></iframe>
</center>  

  <p>&nbsp;</p>
	<p>Este es el código de Visual C# 2005 de la página que habrás creado usando las indicaciones 
	de la primera parte del <a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01.htm">Tutorial de acceso a datos en sitio Web creado con Visual Web 
Developer 2005 Express y SQL Server 2005 Express</a>.</p>
	<p>&nbsp;</p>
    <div align="center">
    <table style="border-collapse: collapse;" id="tablaVB" border="1" bordercolor="#000000" cellpadding="2" width="100%">
      <tbody><tr>
          <td style="text-align: left;" bgcolor="#ccffcc">
  <h3>&nbsp;El código de Visual C# 2005</h3>
          </td>
      </tr>
      <tr>
          <td style="text-align: left;">
<pre><span style="color: rgb(0, 0, 255);">using</span> System;
<span style="color: rgb(0, 0, 255);">using</span> System.Data;
<span style="color: rgb(0, 0, 255);">using</span> System.Configuration;
<span style="color: rgb(0, 0, 255);">using</span> System.Collections;
<span style="color: rgb(0, 0, 255);">using</span> System.Web;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.Security;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI.WebControls;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI.WebControls.WebParts;
<span style="color: rgb(0, 0, 255);">using</span> System.Web.UI.HtmlControls;

<span style="color: rgb(0, 0, 255);">using</span> System.Data.SqlClient;
<span style="color: rgb(0, 0, 255);">using</span> System.Text;
<span style="color: rgb(0, 0, 255);">using</span> System.Security.Cryptography;

<span style="color: rgb(0, 0, 255);">public</span> <span style="color: rgb(0, 0, 255);">partial</span> <span style="color: rgb(0, 0, 255);">class</span> AgregarUsuario_cs : System.Web.UI.Page
{
    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> Page_Load(<span style="color: rgb(0, 0, 255);">object</span> sender, EventArgs e)
    {

    }
    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> btnNuevo_Click(<span style="color: rgb(0, 0, 255);">object</span> sender, EventArgs e)
    {
        <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = "";
        <span style="color: rgb(0, 128, 0);">//</span>
        <span style="color: rgb(0, 128, 0);">// Comprobamos si el nombre ya existe</span>
        <span style="color: rgb(0, 0, 255);">using</span> (SqlConnection cnn = <span style="color: rgb(0, 0, 255);">new</span> SqlConnection(<span style="color: rgb(0, 0, 255);">this</span>.SqlDataSource1.ConnectionString))
        {
            SqlCommand cmd = <span style="color: rgb(0, 0, 255);">new</span> SqlCommand( 
                <span style="color: rgb(178, 34, 34);">"SELECT Count(*) "</span> + 
                <span style="color: rgb(178, 34, 34);">"FROM Usuarios "</span> + 
                <span style="color: rgb(178, 34, 34);">"WHERE Correo = @Correo"</span>, cnn);
            <span style="color: rgb(0, 128, 0);">// Abrimos la conexión</span>
            cnn.Open();
            <span style="color: rgb(0, 128, 0);">// Añadimos el valor del parámetro de la consulta</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text);
            <span style="color: rgb(0, 128, 0);">// Si devuelve algun valor, es que ya existe</span>
            <span style="color: rgb(0, 0, 255);">int</span> i = (<span style="color: rgb(0, 0, 255);">int</span>)cmd.ExecuteScalar();
            <span style="color: rgb(0, 0, 255);">if</span>( i &gt; 0 )
            {
                <span style="color: rgb(0, 128, 0);">// Avisamos y salimos</span>
                <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"El usuario ya existe"</span>;
                <span style="color: rgb(0, 0, 255);">return</span>;
            }
            <span style="color: rgb(0, 128, 0);">// Al salir del bloque using se cierra la conexión</span>
        }
        <span style="color: rgb(0, 128, 0);">// El usuario no existe, lo anadimos</span>
        <span style="color: rgb(0, 0, 255);">using</span> (SqlConnection cnn = <span style="color: rgb(0, 0, 255);">new</span> SqlConnection(<span style="color: rgb(0, 0, 255);">this</span>.SqlDataSource1.ConnectionString))
        {
            <span style="color: rgb(0, 128, 0);">// Usamos el comando Insert del DataSource</span>
            SqlCommand cmd = <span style="color: rgb(0, 0, 255);">new</span> SqlCommand(<span style="color: rgb(0, 0, 255);">this</span>.SqlDataSource1.InsertCommand, cnn);
            <span style="color: rgb(0, 128, 0);">// Abrimos la conexion</span>
            cnn.Open();
            <span style="color: rgb(0, 128, 0);">// Añadimos el valor del parámetro de la consulta</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text);
            <span style="color: rgb(0, 128, 0);">// La clave la guardaremos como un valor SHA1</span>
            <span style="color: rgb(0, 0, 255);">string</span> clave;
            clave = FormsAuthentication.HashPasswordForStoringInConfigFile( 
                txtClave.Text, <span style="color: rgb(178, 34, 34);">"SHA1"</span>);
            <span style="color: rgb(0, 128, 0);">//clave = generarClaveSHA1(txtClave.Text);</span>
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Clave"</span>, clave);
            <span style="color: rgb(0, 128, 0);">// La fecha será la actual</span>
            txtFecha.Text = DateTime.Now.ToString();
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Fecha"</span>, txtFecha.Text);
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Nombre"</span>, txtNombre.Text);
            cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Comentarios"</span>, txtComentarios.Text);
            <span style="color: rgb(0, 128, 0);">// Ejecutamos el comando de inserción</span>
            cmd.ExecuteNonQuery();
            <span style="color: rgb(0, 128, 0);">// Al salir del bloque using se cierra la conexión</span>
        }
        <span style="color: rgb(0, 0, 255);">this</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"Se ha añadido el nuevo usuario correctamente"</span>;
    }

    <span style="color: rgb(0, 128, 0);">// Esta función es la que puedes usar en lugar del método</span>
    <span style="color: rgb(0, 128, 0);">// HashPasswordForStoringInConfigFile</span>
    <span style="color: rgb(0, 128, 0);">// Necesita una importación del espacio de nombres:</span>
    <span style="color: rgb(0, 128, 0);">// System.Security.Cryptography</span>
    <span style="color: rgb(0, 0, 255);">private</span> <span style="color: rgb(0, 0, 255);">string</span> generarClaveSHA1(<span style="color: rgb(0, 0, 255);">string</span> clave)
    {
        <span style="color: rgb(0, 128, 0);">// Crear una clave SHA1 como la generada por</span>
        <span style="color: rgb(0, 128, 0);">// FormsAuthentication.HashPasswordForStoringInConfigFile</span>
        UTF8Encoding enc = <span style="color: rgb(0, 0, 255);">new</span> UTF8Encoding();
        <span style="color: rgb(0, 0, 255);">byte</span>[] data = enc.GetBytes(clave);
        <span style="color: rgb(0, 0, 255);">byte</span>[] result;
        <span style="color: rgb(0, 128, 0);">//</span>
        SHA1CryptoServiceProvider sha = <span style="color: rgb(0, 0, 255);">new</span> SHA1CryptoServiceProvider();
        result = sha.ComputeHash(data);
        <span style="color: rgb(0, 128, 0);">//</span>
        <span style="color: rgb(0, 128, 0);">// Convertir los valores en hexadecimal</span>
        <span style="color: rgb(0, 128, 0);">// cuando tiene una cifra hay que rellenarlo con cero</span>
        <span style="color: rgb(0, 128, 0);">// para que siempre ocupen dos dígitos.</span>
        StringBuilder sb = <span style="color: rgb(0, 0, 255);">new</span> StringBuilder();
        <span style="color: rgb(0, 0, 255);">for</span> (<span style="color: rgb(0, 0, 255);">int</span> i = 0; i &lt; result.Length; i++)
        {
            <span style="color: rgb(0, 128, 0);">// Para que tengan 2 cifras hexadecimales</span>
            <span style="color: rgb(0, 128, 0);">// y las letras sean en mayúsculas</span>
            sb.Append(result[i].ToString(<span style="color: rgb(178, 34, 34);">"X2"</span>));
        }
        <span style="color: rgb(0, 128, 0);">//</span>
        <span style="color: rgb(0, 0, 255);">return</span> sb.ToString();
    }

    <span style="color: rgb(0, 128, 0);">// Este código solo es necesario si no se valida en el lado del cliente,</span>
    <span style="color: rgb(0, 128, 0);">// lo dejo porque forma parte de las pruebas a realizar.</span>
    <span style="color: rgb(0, 128, 0);">//</span>
    <span style="color: rgb(0, 128, 0);">// Pero para usarlo en el lado del cliente hay que comentarlo.</span>
    <span style="color: rgb(0, 0, 255);">protected</span> <span style="color: rgb(0, 0, 255);">void</span> CustomValidator1_ServerValidate(<span style="color: rgb(0, 0, 255);">object</span> source, 
        System.Web.UI.WebControls.ServerValidateEventArgs args)
    {
        args.IsValid = (args.Value.Length &gt; 5);
    }  

}
</pre>
</td>
      </tr>
    </tbody></table>
  </div>
  <p>&nbsp;</p>
	<ul>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01_codigo_aspx.htm">El código de la página AgregarUsuario.aspx</a></li>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01_codigo_vb.htm">El código para Visual 
		Basic 2005</a></li>
	</ul>
	<p align="center"><b><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01.htm">Volver a la página 
	explicativa</a></b></p>
	<p>&nbsp;</p></td>
</tr>
</tbody></table>
</div>
<br>
</div>
<hr style="border: 3px none ;">
<p align="center"><a href="http://www.elguille.info/default.aspx">
<img src="acceso_datos_sql01_codigo_cs_files/el_guille_002.gif" alt="Ir al índice principal de el Guille" style="border: 0px none ;" height="50" width="200"></a></p>
</body></html>