<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head>


<meta http-equiv="Window-target" content="_top">
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="MS.LOCALE" content="es">
<meta name="MSHAttr" content="DocSet:NETFramework">
<meta name="MSHAttr" content="DevLang:CSharp">
<meta name="MSHAttr" content="DocSet:C#">
<meta name="MSHAttr" content="DevLang:VB">
<meta name="MSHAttr" content="DocSet:Visual Basic">

<meta name="MSHAttr" content="DevLang:ADO">
<meta name="MSHAttr" content="DevLang:ASP">

<link href="acceso_datos_sql01_files/estiloArticulosGuille.css" type="text/css" rel="stylesheet">
<meta name="Author" content="Guillermo 'guille' Som">
<meta name="Search.TopicType" content="kbArticle">
<meta name="Search.PublishDate" content="Sat, 03 Feb 2007 01:30:00 GMT">
<meta name="Search.RevisedDate" content="Sat, 03 Feb 2007 01:30:00 GMT"><title>Tutorial de acceso a datos en sitio Web usando VWD y SQL Server 2005 (parte 1)</title>


<meta name="description" content="En esta primera parte del tutorial, vas a ver cómo crear un proyecto Web, crear una base de datos de SQL Server 2005 desde el IDE del Visual Web Developer (VWD), añadir controles a una página Web ASPX, añadir controles de validación, comprobar si un usuario ya está en la base de datos, y en caso de que no esté, añadirlo."></head><body alink="#ff0000" bgcolor="#d7d7ff" link="#0000ff" vlink="#0000ff">

<script language="JavaScript">
var gsPath = "../../../"
function IrADeLista(){
    var s1 = gsBanner.D1.selectedIndex;
    var s2 = gsBanner.D1.options[s1].value;
    if( s2 != "Selecciona" )
        window.location = gsPath + s2;
}
</script>
<script language="JavaScript" src="acceso_datos_sql01_files/elGuille.js"></script><table border="1" width="100%">  <tbody><tr>    <td rowspan="2" align="middle" valign="middle" width="200">       <a href="http://www.elguille.info/default.aspx">       <img src="acceso_datos_sql01_files/el_guille.gif" alt="ir al indice principal" border="0"></a>    </td>    <td align="middle">       <font color="#000080" face="Comic Sans MS" size="4"><strong><a href="http://www.elguille.info/el_guille.aspx" style="color: navy;"><acronym title="Quien es el Guille?">el Guille</acronym></a>, la Web del Visual Basic, C#, .NET y más...</strong></font>    </td>  </tr>   <tr>       <td align="middle" background="acceso_datos_sql01_files/barra_grisclaro.png" height="20"><b><font face="Verdana" size="1">&nbsp;       <a href="http://www.elguille.info/lonuevo/2007/octubre/Default.aspx"><acronym title="Lo Nuevo de este mes">Lo+</acronym></a> -       <a href="http://www.elguille.info/NET/WinFX/default.aspx"><acronym title="Indice de WinFX, WPF, WWF, WCF y .NET 3.0">WinFX</acronym></a> -       <a href="http://www.elguille.info/NET/default.aspx"><acronym title="El indice de punto NET">.NET</acronym></a> -       <a href="http://www.elguille.info/NET/ADONET/indiceADONET.asp"><acronym title="Bases de datos de punto NET">ADO.NET</acronym></a> -       <a href="http://www.elguille.info/NET/ASPNET/indiceASPNET.aspx"><acronym title="Paginas y servicios Web en punto NET">ASP.NET</acronym></a> -       <a href="http://www.elguille.info/NET/comodotnet.aspx"><acronym title="Como... en punto NET">Cómo...</acronym></a> -       <a href="http://www.elguille.info/colabora/colabora.htm"><acronym title="Las colaboraciones">Colabora</acronym></a> -       <a href="http://www.elguille.info/vb/default.aspx"><acronym title="El indice de Visual Basic 6">VB6</acronym></a> -       <a href="http://www.elguille.info/vb/VB_API.HTM"><acronym title="API de Windows (VB6)">API</acronym></a> -       <a href="http://www.elguille.info/HTMLscripts/HTML_Tip.aspx"><acronym title="Lenguajes Scripts y HTML">HTML</acronym></a> -       <a href="http://www.elguille.info/sistema/Vista/Default.aspx"><acronym title="Articulos y trucos para Windows Vista">Vista</acronym></a> -       <a href="http://www.elguille.info/otrositios/Default.aspx"><acronym title="Otros sitios">Links</acronym></a>&nbsp;-       <a href="http://www.elguille.info/foros_guille.aspx"><acronym title="Los foros del Guille">Foros</acronym></a>       &nbsp;</font></b></td>   </tr></tbody></table><div class="colorClaro" style="padding-top: 1em; padding-bottom: 1em;" align="center"><h2>elGuille.hosting:    Oferta de <a href="http://www.elguille.info/hostings/elguille_ofertas_hosting.asp">alojamiento multi dominio</a></h2>	<h3>Por solo 40.95 Euros al mes...</h3></div>
<hr style="border: 3px none ;">
&nbsp;
<div align="center">
<table style="border-collapse: collapse;" id="tablePanorama" bgcolor="#ffffff" border="1" bordercolor="#000000" cellpadding="8" width="770">
<tbody><tr><td style="padding: 0cm 5pt; width: 770px;" align="left" bgcolor="#0000ff" valign="top" width="770">
<a href="http://www.elguille.info/NET/ASPNET/indiceASPNET.aspx"><font color="#ffffff" size="6"><b><acronym title="Ir a la sección de ASP.NET">
ASP.NET</acronym></b></font></a></td>
</tr>
<tr>
<td style="padding: 0cm 5pt; width: 770px;" align="left" valign="top" width="770">
&nbsp;<h1>Tutorial de acceso a datos en sitio Web creado con Visual Web 
Developer 2005 Express y SQL Server 2005 Express</h1>
<p>&nbsp;</p>
<h3>Parte 1:<br>
Crear el sitio y crear nuevos usuarios, comprobando si ya existen 
para no repetirlos</h3>
<h5>&nbsp;</h5>
<h5>Publicado el 03/Feb/2007<br>Actualizado el 03/Feb/2007<br>Autor: Guillermo 'guille' Som</h5>
<p>&nbsp;</p>
<center>
<script type="text/javascript"><!--
google_ad_client = "pub-3672683940926460";
google_ad_width = 728;
google_ad_height = 90;
google_ad_format = "728x90_as";
google_ad_type = "text";
//2007-04-01: net2005
google_ad_channel = "6593407188";
google_color_border = "FFFFFF";
google_color_bg = "FFFFFF";
google_color_link = "0000FF";
google_color_text = "000000";
google_color_url = "000000";
//-->
</script>
<script type="text/javascript" src="acceso_datos_sql01_files/show_ads.js">
</script><iframe name="google_ads_frame" src="acceso_datos_sql01_files/ads.htm" marginwidth="0" marginheight="0" vspace="0" hspace="0" allowtransparency="true" frameborder="0" height="90" scrolling="no" width="728"></iframe>
</center>
&nbsp;
</td>
</tr>
</tbody></table>
</div>

<div>
<br>
<div align="center">
<table style="border-collapse: collapse;" bgcolor="#ffffff" border="1" bordercolor="#000000" cellpadding="2" cellspacing="8" width="770">
 <tbody><tr>
  <td style="padding: 0cm 5pt; width: 770px;" align="left" valign="top" width="770">
  &nbsp;<h3>Introducción</h3>
  <p>En esta primera parte del <a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos.htm">tutorial de cómo utilizar bases de datos en un 
	sitio Web usando Visual Web Developer 2005 Express</a>, vas a ver cómo crear un 
	proyecto Web, crear una base de datos de SQL Server 2005 desde el IDE del 
	Visual Web Developer (VWD), añadir controles a una página Web ASPX, añadir 
	controles de validación, comprobar si un usuario ya está en la base de 
	datos, y en caso de que no esté, añadirlo.</p>
	<p>&nbsp;</p>
	<p class="Nota"><b>Nota:</b><br>
	El código mostrado aquí es para Visual Basic 2005, pero <a href="#codigo">
	más abajo</a> tienes los links para el código completo, tanto para Visual 
	Basic como para C#.</p>
	<p>&nbsp;</p>
  <h3>Ejemplo paso a paso</h3>
<div>
    <ul>
		<li>0- Abre el Visual Studio 2005 (o el Visual Web Developer 2005 
		Express)</li>
		<li>1- Crea un nuevo proyecto ASP.NET (<b>vwdTut01</b>)</li>
		<li>1.a- Elege el lenguaje a usar para el código de forma predeterminada<br>&nbsp;</li>
		<li>2- Añade un nuevo elemento</li>
		<li>2.a- Elige <b>Base de datos de SQL Server</b> y dale el nombre <b>vwdTut01.mdf</b></li>
		<li>2.b- Nos avisa de que la base de datos debe estar en la carpeta <b>App_Data</b>, 
		acepta<br>&nbsp;</li>
		<li>3- Crea una tabla (debes mostrar la ficha <b>Explorador de bases de datos</b>)</li>
		<li>3.a- Usa estos campos:<ul>
		<li>3.b- ID, int, Identidad</li>
		<li>3.c- Correo, nvarchar(64)</li>
		<li>3.d- Clave, nvarchar(40)</li>
		<li>3.e- Nombre, nvarchar(50)</li>
		<li>3.f- Fecha, datetime</li>
		<li>3.g- Comentarios, nvarchar(300)</li>
	</ul>
    	</li>
		<li>3.h- Dale a guardar y ponle el nombre <b>Usuarios</b><br>&nbsp;</li>
		<li>4- Ahora te explico cómo crear el formulario de introducción de datos.</li>
		<li>4.a- En el menú <b>Sitio Web</b> selecciona <b>Agregar nuevo elemento</b></li>
		<li>4.b- Selecciona <b>WebForms</b> y dale el nombre <b>AgregarUsuario.aspx</b></li>
		<li>4.c- El lenguaje será el indicado al principio, pero lo puedes cambiar (yo dejo
    Visual Basic)</li>
		<li>4.d- Marca la casilla <b>Colocar el código en un archivo independiente</b> para que se
    separe el diseño del formulario del código que vamos a escribir.<br>&nbsp;</li>
		<li>5- Ahora vamos a añadir una tabla, para que queden alineado los textos y las cajas de textos</li>
		<li>5.a- En el menú <b>Diseño</b> seleccionar <b>Insertar tabla</b></li>
		<li>5.b- En el cuadro de diálogo de insertar tabla, selecciona:<br>
		3 filas y 2 columnas, ancho 90%, Alinear: center, Atributos: borde: 1, Espaciado
    celdas: 4<br>&nbsp;</li>
		<li>6- En la tabla recién creada, añade una etiqueta en la primera columna, un 
		<b>textBox</b> en la segunda columna<br>&nbsp;</li>
		<li>7- Queremos que estén alineadas a la izquierda y arriba</li>
		<li>7.a- Selecciona la celda (pulsando en la flecha que sale al pasar el 
		ratón)</li>
		<li>7.b- En la ventana de propiedades, en <b>align</b> selecciona <b>left</b> y en 
		<b>VAlign</b> selecciona <b>top</b><br>&nbsp;</li>
		<li>8- Selecciona esa fila y pulsa en <b>Copiar</b> de la barra de 
		herramientas</li>
		<li>8.a- Ahora, al pulsar en el botón <b>Pegar</b> y se añadirá una nueva fila con los controles</li>
		<li>8.b- Selecciona la siguiente fila (la vacía) y pulsa en pegar</li>
		<li>8.c- Repite los pasos anteriores hasta que tengas 4 filas con los controles<br>&nbsp;</li>
		<li>9- Añade un botón en la siguiente fila</li>
		<li>9.a- Selecciona la fila del botón</li>
		<li>9.b- En el menú <b>Diseño</b> selecciona <b>Combinar celda</b></li>
		<li>9.c- De esa forma, esa columna ocupará toda la fila<br>&nbsp;</li>
		<li>10- En la última fila, añade una etiqueta</li>
		<li>10.a- Selecciona esa última fila para que ocupe las dos columnas, ya sabes:</li>
		<li>10.b- En el menú <b>Diseño</b>, selecciona <b>Combinar celda</b><br>&nbsp;</li>
		<li>11- Selecciona esa etiqueta y en la ventana de propiedades busca la 
		propiedad <b>Width</b> y escribe
    100% para que ocupe todo el ancho.<br>&nbsp;</li>
		<li>12- Cambia el texto de las 4 primeras etiquetas para que muestre: <b>Correo</b>, 
		<b>Clave</b>,
    <b>Nombre</b> y <b>Comentarios</b><br>&nbsp;</li>
		<li>13- Como puede ser que no interese que se vea la clave escrita, selecciona la segunda caja
    de textos</li>
		<li>13.a- En la ventana de propiedades, en la propiedad <b>TextMode</b> selecciona
		<b>Password</b><br>&nbsp;</li>
		<li>14- Selecciona la última caja de textos, te digo lo que hay que 
		hacer para que tenga más espacio para
    escribir</li>
		<li>14.a- En la ventana de propiedades, en la propiedad <b>TextMode</b> selecciona
		<b>Multiline</b></li>
		<li>14.b- En la propiedad <b>Rows</b> escribe 4 y en <b>Columns</b> 
		escribe 60<br>&nbsp;</li>
		<li>15- Selecciona el botón y en el texto escribe <b>Nuevo usuario</b><br>&nbsp;</li>
		<li>16- Lo correcto es que los controles tengan nombres que indiquen para que son</li>
		<li>16.a- Siguiendo el orden de arriba abajo, a las cajas de texto dale estos nombres:<ul>
		<li>16.b- <b>txtCorreo</b>, <b>txtClave</b>, <b>txtNombre</b> y <b>txtComentarios</b><br>&nbsp;</li>
	</ul>
    	</li>
		<li>17- Al botón dale el nombre <b>btnNuevo</b><br>&nbsp;</li>
		<li>18- A la etiqueta del final, dale el nombre <b>lblAviso</b>, el resto 
		déjalas con
    el nombre que tienen ya que no las usaremos desde el código y da igual el nombre,
    pero si quieres, le puedes dar el nombre que te apetezca, aunque ya puestos, 
		podría
    ser como el de la caja de textos que tienen al lado, pero en lugar de <b>txt</b> puedes
    usar <b>lbl</b>.<br>&nbsp;</li>
		<li>19- Ahora vamos a darle funcionalidad al botón, de forma que al pulsar en 
		él se
    cree un nuevo usuario con los datos que tenemos</li>
		<li>19.a- Como queremos que las cosas se hagan bien, después añadiremos validadores
    para que se escriba lo que haya que escribir</li>
		<li>19.b- Haz dobleclic en el botón para que se muestre la ventana de 
		código</li>
		<li>19.c- El código se habrá mostrado en un fichero aparte con el mismo nombre que la
    página y con la extensión del lenguaje que has elegido, en mi caso es: <b>AgregarUsuario.aspx.vb</b></li>
		<li>19.d- Antes de hacer nada te explico que es lo que habría que hacer para 
		añadir
    correctamente los datos.<br>&nbsp;</li>
		<li>20- No debemos admitir ninguna de las cajas en blanco, salvo la de comentarios (ahora
    veremos como)<br>&nbsp;</li>
		<li>21- La fecha la podremos nosotros de forma automática, para que tenga la fecha actual</li>
		<li>21.a- Para que se muestre la fecha, deberíamos agregar una nueva fila, por ejemplo,
    entre el nombre y los comentarios</li>
		<li>21.b- Selecciona la fila del nombre y pulsa en copiar</li>
		<li>21.c- Selecciona la fila de los comentarios y pulsa en pegar, se insertara una nueva
    fila</li>
		<li>21.d- Cambia el texto de la etiqueta a <b>Fecha</b> y el nombre de la caja de textos a
		<b>txtFecha</b></li>
		<li>21.e- Como la fecha es de solo lectura, selecciona la caja de textos y en las propiedades,
    asigna el valor <b>True</b> a la propiedad <b>ReadOnly</b></li>
		<li>21.f- Para que se vea de otro color, en las propiedades, selecciona 
		<b>BackColor</b> y
    en el cuadro de propiedades que te muestra, selecciona la ficha <b>Web</b> y el color
		<b>WhiteSmoke</b><br>&nbsp;</li>
		<li>22- Otra cosa a hacer es que si ese correo ya existe, que diga que no es válido<br>&nbsp;</li>
		<li>23- Pero antes de hacer nada, necesitamos crear la conexión a la base de datos<br>&nbsp;</li>
		<li>24- Con el Visual Web Developer Express y el SQL Express la forma mas 
		fácil de crear una conexión
    a la base que hemos creado es haciendo lo siguiente: (<font color="#800080">a lo mejor hay otra forma
    mejor, pero... esto me funciona siempre</font>)</li>
		<li>24.a- Muestra la página de agregar usuario en modo diseño</li>
		<li>24.b- En el explorador de bases de datos, arrastra la tabla de <b>Usuarios</b> a la 
		página</li>
		<li>24.c- Esto creará un <b>GridView</b> y un control <b>DataSource</b>, el 
		<b>GridView</b> lo vamos a borrar</li>
		<li>24.d- Selecciona solo el <b>GridView</b> y pulsa la tecla suprimir, pulsa antes en cualquier
    parte de la página y después selecciona el grid</li>
		<li>24.e- Ahora tendrás un control llamado <b>SqlDataSource1</b> que 
		tendrá todos los comandos
    para insertar, eliminar, actualizar, etc.</li>
		<li>24.f- También se habrá creado el fichero <b>web.config</b> con los datos de 
		conexión a
    la base de datos<br>&nbsp;</li>
		<li>25- Vamos a añadir controles de validación para que el usuario tenga 
		que escribir algo en ellos</li>
		<li>25.a- Muestra la página en modo de diseño y del <b>Cuadro de herramientas</b>, selecciona
    el grupo <b>Validación</b></li>
		<li>25.b- Arrastra un control <b>RequiredFieldValidator</b> y déjalo al lado del 
		<b>textBox</b> del
    correo</li>
		<li>25.c- Seguramente se pondrá debajo de la caja de textos, posiciónate justo delante
    del control de validación y borra (con la tecla backspace) el espacio que 
		habrá, para que
    quede pegado al <b>textBox</b>, después puedes pulsar un espacio para que haya algo de
    	separación</li>
		<li>25.d- Añade otro al lado de la caja de textos de la clave y otro al lado del 
		<b>textBox</b>
    del nombre</li>
		<li>25.e- Para la fecha y los comentarios no hace falta añadir ninguno<br>&nbsp;</li>
		<li>26- Como queremos que la cuenta de correos sea valida, vamos a 
		añadir un control
    de <b>validación de expresiones regulares</b> junto al <b>textBox</b> del correo (detrás del validador
    que ya había)</li>
		<li>26.a- En la ventana de propiedades, selecciona la propiedad <b>ValidationExpression</b>
    y pulsa en el botón</li>
		<li>26.b- Del cuadro de dialogo selecciona <b>Dirección de correo 
		electrónico de Internet</b>
    y pulsa en aceptar<br>&nbsp;</li>
		<li>27- Ahora vamos a enlazar esos controles de validación con las cajas de texto correspondientes</li>
		<li>27.a- Selecciona el primer <b>RequiredFieldValidator</b> (<b>Correo</b>) y busca la propiedad
		<b>ControlToValidate</b> y de la lista desplegable que te mostrará, selecciona
		<b>txtCorreo</b></li>
		<li>27.b- Haz lo mismo con el control <b>RegularExpressionValidator</b> 
		(el de la expresiones regulares)</li>
		<li>27.c- Ahora el de la clave y después el del nombre, seleccionando los controles
    correspondientes en la propiedad <b>ControlToValidate</b></li>
		<li>27.d- Puedes cambiar el mensaje de aviso de cada uno de los controles de 
		validación,
    con idea de que si, por ejemplo, no se escribe nada en la clave diga que debe escribir
    algo... La propiedad que debes asignar es <b>ErrorMessage</b>.<br>&nbsp;</li>
		<li>28- Si queremos que la clave tenga un mínimo de caracteres, podemos agregar un control
    	<b>CustomValidator</b>, indica que control se debe validar, escribe el texto del
    mensaje de error, por ejemplo: <b>Debes escribir más de 5 caracteres</b></li>
		<li>28.a- Haz dobleclic en el control de validación y en el evento que se crea en
    el fichero de código, escribe lo siguiente: (<font color="#800080">args es 
		el nombre del segundo parámetro</font>)</li>
	</ul>
    <pre>args.IsValid = (args.Value.Length &gt; 5)</pre>
    <ul>
		<li>28.b - Esto hará que se compruebe que no este vacío y que tenga más de 5 caracteres<br>&nbsp;</li>
		<li>29- Si en lugar de hacer la validación en el servidor, quieres hacerla en el 
		lado del cliente, tendrás que crear un código <b>Script</b> en la pagina con este 
		código:</li>
	</ul>
<pre><span style="color: rgb(0, 0, 160);">&lt;</span><span style="color: rgb(178, 34, 34);">script</span> <span style="color: rgb(255, 0, 0);">type</span><span style="color: rgb(0, 0, 160);">=</span><span style="color: rgb(0, 0, 255);">"text/javascript"</span><span style="color: rgb(0, 0, 160);">&gt;</span>
<span style="color: rgb(0, 0, 255);">function</span> comprobarClave(oSrc, args){
    args.IsValid = (args.Value.length &gt; 5);
}
<span style="color: rgb(0, 0, 160);">&lt;</span><span style="color: rgb(0, 0, 160);">/</span><span style="color: rgb(178, 34, 34);">script</span><span style="color: rgb(0, 0, 160);">&gt;</span>
</pre>
    <ul>
		<li>29.a- Selecciona el control y en la propiedad <b>ClientValidationFunction</b> escribe el
    nombre de la función, en este caso <b>comprobarClave</b>.<br>&nbsp;</li>
		<li>30- Como los controles de validación se empeñan en ponerse como les da la gana,
    si quieres, puedes poner todos esos controles de validación en la parte inferior
    de la tabla, aunque en el caso de que, por ejemplo, el usuario pulse en el 
		botón sin haber escrito
    nada, le mostrará todos los mensajes de error, por tanto, esos mensajes 
		deberían
    decir lo que queremos que haga el usuario, es decir, no lo dejes con el texto predeterminado.<br>&nbsp;</li>
		<li>31- Antes de seguir, decirte que si la caja de textos está en modo 
		<b>Password</b>, y
    cuando se compruebe por código si el usuario existe, etc., y se cancele la 
		creación
    del usuario, lo que se escriba se borrará, así que si quieres que se siga manteniendo
    la contraseña, debes dejarla como texto normal. En cualquier caso, mejor dejarlo
    como <b>Password</b> y si el usuario se equivoca, pues... que hubiese prestado más 
		atención,
    je, je.<br>&nbsp;</li>
		<li>32- Ahora vamos a escribir el código de validación de que el usuario no exista ya
    y en caso de que exista, que se cancele la inserción de datos, y si no existe, que
    se añada a la base de datos.</li>
		<li>32.a- Muestra el código del evento del botón (el que creaste en el punto 19)</li>
		<li>32.b- Al principio del fichero añade las importaciones de los espacios
    de nombres que vamos a usar, en particular el <b>System.Data.SqlClient</b></li>
		<li>32.c- Lo primero es comprobar si el usuario ya existe, por tanto vamos a ejecutar
    la siguiente sentencia (cadena de selección): </li>
	</ul>
<pre><span style="color: rgb(0, 0, 255);">SELECT</span> <span style="color: rgb(0, 0, 255);">Count</span>(*) <span style="color: rgb(0, 0, 255);">FROM</span> Usuarios <span style="color: rgb(0, 0, 255);">WHERE</span> Correo = @Correo</pre>
    <ul>
		<li>32.d- Esto hará que se compruebe en la tabla de <b>Usuarios</b> si el correo escrito ya
    está, el truco es que si esas instrucciones devuelven algún valor que no sea cero,
    es que ya hay una cuenta de correo como la que buscamos.</li>
		<li>32.e- Para ejecutar esa sentencia de SQL vamos a usar un objeto <b>SqlConnection</b> y
    un objeto <b>SqlCommand</b></li>
		<li>32.f- Para el objeto <b>Connection</b> necesitas la cadena de 
		conexión, y como ya tenemos
    en el formulario (pagina Web) un objeto <b>SqlDataSource</b>, pues la tomamos de 
		ahí.</li>
		<li>32.g- Este es el código para comprobar si el usuario ya existe, verás que uso una 
		instrucción <b>Using</b> para controlar la conexión, de esa forma, si nos salimos nos aseguramos
    de que el objeto se destruye y se cierra la conexión, ya que esa instrucción 
		se encarga de liberar todos los recursos
    que estuviera usando al llegar al final del bloque, en Visual Basic, será al 
		llegar a <b>End Using</b>. </li>
	</ul>
<pre><span style="color: rgb(0, 128, 0);">' Comprobamos si el nombre ya existe</span>
<span style="color: rgb(0, 0, 255);">Using</span> cnn <span style="color: rgb(0, 0, 255);">As</span> <span style="color: rgb(0, 0, 255);">New</span> SqlConnection(<span style="color: rgb(0, 0, 255);">Me</span>.SqlDataSource1.ConnectionString)
    <span style="color: rgb(0, 0, 255);">Dim</span> cmd <span style="color: rgb(0, 0, 255);">As</span> <span style="color: rgb(0, 0, 255);">New</span> SqlCommand( _
            <span style="color: rgb(178, 34, 34);">"SELECT Count(*) "</span> &amp; _
            <span style="color: rgb(178, 34, 34);">"FROM Usuarios "</span> &amp; _
            <span style="color: rgb(178, 34, 34);">"WHERE Correo = @Correo"</span>, cnn)
    <span style="color: rgb(0, 128, 0);">' Abrimos la conexión</span>
    cnn.Open()
    <span style="color: rgb(0, 128, 0);">' Añadimos el valor del parámetro de la consulta</span>
    cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text)
    <span style="color: rgb(0, 128, 0);">' Si devuelve algún valor, es que ya existe</span>
    <span style="color: rgb(0, 0, 255);">Dim</span> i <span style="color: rgb(0, 0, 255);">As</span> <span style="color: rgb(0, 0, 255);">Integer</span>
    i = <span style="color: rgb(0, 0, 255);">CInt</span>(cmd.ExecuteScalar())
    <span style="color: rgb(0, 0, 255);">If</span> i &gt; 0 <span style="color: rgb(0, 0, 255);">Then</span>
        <span style="color: rgb(0, 128, 0);">' Avisamos y salimos</span>
        <span style="color: rgb(0, 0, 255);">Me</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"El usuario ya existe"</span>
        <span style="color: rgb(0, 0, 255);">Exit</span> <span style="color: rgb(0, 0, 255);">Sub</span>
    <span style="color: rgb(0, 0, 255);">End</span> <span style="color: rgb(0, 0, 255);">If</span>
    <span style="color: rgb(0, 128, 0);">' Al salir del bloque Using se cierra la conexión</span>
<span style="color: rgb(0, 0, 255);">End</span> <span style="color: rgb(0, 0, 255);">Using</span>
</pre>    
    <ul>
		<li>32.h- El parámetro <b>@Correo</b> lo asignamos usando el método <b>AddWithValue</b> que es la
    forma más cómoda de crear los parámetros al tiempo que se le asigna el valor que
    	tendrá.</li>
		<li>32.i- Al llamar al método <b>ExecuteScalar</b> del comando, le estamos diciendo que devuelva
    la primera columna de la primera fila, y como resulta que lo que queremos es el
    número de veces que esté en la tabla <b>Usuarios</b> esa cuenta de correo, pues si ya está
    una vez, devolverá un 1, si no está devolverá un cero. El valor que devuelve esa
    	función es de tipo <b>Object</b>, ya que en realidad el tipo devuelto depende de lo que pongamos 
		después de <b>SELECT</b>,
    en este caso es un valor entero, que es lo que devuelve la función <b>Count(*)</b>.</li>
		<li>32.j- Si lo que devuelve es mayor de cero, es que hay algún correo como el que se
    ha escrito, por tanto mostramos el mensaje de error y salimos del método.<br>&nbsp;</li>
		<li>33- Si se continúa, es decir, se llega después del <b>End Using</b>, es que no existe esa
    cuenta de correo, por tanto debemos agregar los datos.</li>
		<li>33.a- Ahora debemos hacer casi lo mismo de antes, pero ejecutando el comando
		<b>Insert</b>, el cual
    	también lo tomaremos del objeto <b>SqlDataSource1</b>.</li>
		<li>33.b- Aunque antes de guardar nada en la base de datos debemos asignar los valores
    de los parámetros, que si te fijas en el código de la página, esos 
		parámetros se
    llaman igual que los campos, pero empezando con la arroba (@).</li>
		<li>33.c- Otra cosa que debemos hacer es convertir el password (la clave) en un valor
    SHA1. Esto es para no guardar la clave como un texto en la base de datos, de esa
    forma, el que vea los datos que hay no sabrá cual es la clave de cada usuario. Ese
    valor SHA1 lo podemos crear usando un objeto de tipo <b>SHA1CryptoServiceProvider</b> o
    bien usar la función <b>HashPasswordForStoringInConfigFile</b> de la clase 
		<b>FormsAuthentication</b>,
    que es lo que normalmente haremos en una pagina Web, ya que así nos evitamos tener
    que crear nuestro propio código. De todas formas, en el código completo, he añadido
    la función para crear ese valor SHA1, por si quieres ver como hacerlo, por ejemplo
    para una aplicación de Windows.</li>
		<li>33.d- Una vez que tenemos todo esto, lo juntamos y lo mezclamos 
		bien... je, je, mejor es que veas el código para que lo tengas más
    claro: </li>
	</ul>
<pre><span style="color: rgb(0, 128, 0);">' El usuario no existe, lo añadimos</span>
<span style="color: rgb(0, 0, 255);">Using</span> cnn <span style="color: rgb(0, 0, 255);">As</span> <span style="color: rgb(0, 0, 255);">New</span> SqlConnection(<span style="color: rgb(0, 0, 255);">Me</span>.SqlDataSource1.ConnectionString)
    <span style="color: rgb(0, 128, 0);">' Usamos el comando Insert del DataSource</span>
    <span style="color: rgb(0, 0, 255);">Dim</span> cmd <span style="color: rgb(0, 0, 255);">As</span> <span style="color: rgb(0, 0, 255);">New</span> SqlCommand(<span style="color: rgb(0, 0, 255);">Me</span>.SqlDataSource1.InsertCommand, cnn)
    <span style="color: rgb(0, 128, 0);">' Abrimos la conexión</span>
    cnn.Open()
    <span style="color: rgb(0, 128, 0);">' Añadimos el valor del parámetro de la consulta</span>
    cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Correo"</span>, txtCorreo.Text)

    <span style="color: rgb(0, 128, 0);">' La clave la guardaremos como un valor SHA1</span>
    <span style="color: rgb(0, 0, 255);">Dim</span> clave <span style="color: rgb(0, 0, 255);">As</span> <span style="color: rgb(0, 0, 255);">String</span>
    clave = FormsAuthentication.HashPasswordForStoringInConfigFile(txtClave.Text, <span style="color: rgb(178, 34, 34);">"SHA1"</span>)
    <span style="color: rgb(0, 128, 0);">'clave = generarClaveSHA1(txtClave.Text)</span>
    cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Clave"</span>, clave)

    <span style="color: rgb(0, 128, 0);">' La fecha a guardar es la actual</span>
    txtFecha.Text = DateTime.Now.ToString()
    cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Fecha"</span>, txtFecha.Text)
    cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Nombre"</span>, txtNombre.Text)
    cmd.Parameters.AddWithValue(<span style="color: rgb(178, 34, 34);">"@Comentarios"</span>, txtComentarios.Text)
    <span style="color: rgb(0, 128, 0);">' Ejecutamos el comando de inserción</span>
    cmd.ExecuteNonQuery()
    <span style="color: rgb(0, 128, 0);">' Al salir del bloque Using se cierra la conexión</span>
<span style="color: rgb(0, 0, 255);">End</span> <span style="color: rgb(0, 0, 255);">Using
</span>
<span style="color: rgb(0, 0, 255);">Me</span>.lblAviso.Text = <span style="color: rgb(178, 34, 34);">"Se ha añadido el nuevo usuario correctamente"</span>
</pre>    
    <ul>
		<li>34- Ya lo único que nos queda es poner en la pagina principal (<b>Default.aspx</b>) un
    link para que podamos entrar a la página de crear nuevos usuarios. En esa misma
    página crearemos links para otras funcionalidades, por ejemplo, modificar un dato
    o ver los datos que tenemos, etc.</li>
		<li>34.a- Muestra la página <b>Default.aspx</b> en modo diseño y del <b>Cuadro de herramientas</b>
    añade un control <b>HyperLink</b>, en la propiedad <b>Text</b> escribe <b>Añadir usuario</b> y en la
    propiedad <b>NavigateUrl</b> pulsa en el botón con los puntos suspensivos para 
		que puedas seleccionar
    la página a la que quieres que navegue cuando se pulse en el link, en este caso la página 
		que debes seleccionar del cuadro de diálogo que te muestra es <b>AgregarUsuario.aspx</b><br>&nbsp;</li>
		<li>35- Vamos a probar que todo funciona, pero antes, en el explorador de soluciones,
    selecciona la página <b>Default.aspx</b> y pulsando con el botón derecho, selecciona del
    	menú contextual la opción <b>Establecer como página de inicio</b>, de esta forma, cada
    vez que pulses <b>F5</b> se iniciara con esa página, si no haces esto que te acabo de comentar,
    cuando pulses <b>F5</b> se iniciara por la página que en ese momento esté seleccionada.<br>&nbsp;</li>
		<li>36- Una vez que esté en ejecución, prueba a no escribir nada en las 
		cajas de texto y pulsa en el botón, verás que salen los mensajes
    de aviso. Sigue haciendo pruebas de validación, por ejemplo no escribas bien el
    correo, escribe menos de 6 caracteres en la clave, etc.<br>&nbsp;</li>
		<li>37- Una vez que hayas probado que las validaciones funcionan, introduce un usuario
    (o varios) y después intenta introducir uno que ya exista, para que veas que se
    muestra el mensaje de error y esas cosas.</li>
	</ul>
	&nbsp;</div>
	<p>Bueno, pues con esto ya tienes para entretenerte un rato.<br>En la 
	próxima parte veremos cómo modificar los datos y cómo mostrar los que hay.<br>Esto 
	último lo haremos de forma automática, usando un <b>GridView</b> y de forma manual,
    para que podamos navegar entre los datos y se muestren uno a uno, etc.<br></p>	
	<p>Espero que te sea de utilidad y sepas agradecerlo... (<font color="#800080">es 
	de bien nacidos ser agradecidos</font>) ;-))))</p>
	<p>Nos vemos.<br>
	Guillermo<br>
	<br>
    Nerja, 2 y 3 de Febrero de 2007</p>
    <hr>
  <h3><a name="codigo"></a>El código de ejemplo para Visual Basic 2005 y Visual 
	C# 2005</h3>
	<ul>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01_codigo_aspx.htm">El código de la página Web</a> (solo el código HTML de la página 
		AgregarUsuario.aspx)</li>
		<li>El código para comprobar si existe el usuario y en caso de que no 
		exista, añadir uno nuevo<ul>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01_codigo_vb.htm">El código para Visual Basic</a></li>
		<li><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos_sql01_codigo_cs.htm">El código para Visual C#</a></li>
	</ul>
		</li>
	</ul>
	<p>&nbsp;</p>
	<p align="center"><b><a href="http://www.elguille.info/NET/ASPNET/tutorial_vwd/acceso_datos.htm">Volver al índice del 
	tutorial</a></b></p>
	<p><br>&nbsp;</p>
</td>
</tr>
</tbody></table>
</div>
<br>
</div>
<hr style="border: 3px none ;">
<p align="center"><a href="http://www.elguille.info/default.aspx">
<img src="acceso_datos_sql01_files/el_guille_002.gif" alt="Ir al índice principal de el Guille" style="border: 0px none ;" height="50" width="200"></a></p>
</body></html>